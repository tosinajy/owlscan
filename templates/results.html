{% extends "layout.html" %}
{% block content %}
<div class="mb-3">
    <a href="{{ url_for('url_history', url=scan.start_url) }}" class="text-decoration-none">
        <i class="bi bi-arrow-left"></i> Back to Scan History
    </a>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2>Analysis Report</h2>
        <p class="lead mb-0">For: <a href="{{ scan.start_url }}" target="_blank">{{ scan.start_url }}</a></p>
    </div>
    <div>
        <span id="status-badge" class="badge fs-6 text-capitalize bg-{% if scan.status == 'completed' %}success{% elif scan.status in ['crawling', 'analyzing'] %}warning text-dark{% else %}danger{% endif %}">{{ scan.status }}</span>
    </div>
</div>

{% if scan.status == 'completed' and analysis %}
<div class="d-flex justify-content-end mb-3">
    <div class="btn-group">
        <a href="{{ url_for('export_csv', scan_id=scan.id) }}" class="btn btn-outline-success"><i class="bi bi-file-earmark-spreadsheet"></i> Export CSV</a>
        <a href="{{ url_for('export_json', scan_id=scan.id) }}" class="btn btn-outline-secondary"><i class="bi bi-filetype-json"></i> Export JSON</a>
    </div>
</div>

<div class="accordion" id="resultsAccordion">
    {% include 'results_components/rate_limit_errors.html' %}
    {% include 'results_components/broken_links.html' %}
    {% include 'results_components/large_images.html' %}
    {% include 'results_components/missing_alt.html' %}
    {% include 'results_components/titles.html' %}
    {% include 'results_components/descriptions.html' %}
    {% include 'results_components/content.html' %}
</div>

{% elif scan.status in ['pending', 'crawling', 'analyzing'] %}
<div class="text-center mt-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <p class="mt-3 fs-5">
        {% if scan.status == 'crawling' %}
            Crawling website...
        {% elif scan.status == 'analyzing' %}
            Analyzing stored data...
        {% else %}
            Starting up...
        {% endif %}
    </p>
</div>
{% else %}
<div class="alert alert-danger">
    <h4>Operation Failed</h4>
    <p>An error occurred during the {{ scan.status }} phase.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if scan.status in ['pending', 'crawling', 'analyzing'] %}
<script>
    const scanId = {{ scan.id }};
    function checkStatus() {
        $.getJSON('/scan_status/' + scanId, function(data) {
            if (['crawled', 'completed', 'failed'].includes(data.status)) {
                window.location.reload();
            } else {
                setTimeout(checkStatus, 3000);
            }
        });
    }
    setTimeout(checkStatus, 3000);
</script>
{% endif %}
{% endblock %}